---
title: "Data preparation"
author: "José C. Pernías"
date: "12/2/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preliminaries

### Load R packages

```{r r-libraries}
library(tidyverse)
```


### Load household data

Read the 2019 household database: 
```{r load-data}
load("data/hogar_2019.Rdata")
```

Most variables are coded with integers. The main exception is `ACTESTB` that uses single capital letters. The following code chunk:

- convert `ACTESTB` to a factor variable
- convert all character variables to integer variables.

```{r transform-char}
hogar_2019 <- hogar_2019 %>%
  mutate(ACTESTB = factor(ACTESTB)) %>%
  mutate(across(where(is.character), as.integer))
```

### Load expenditures data

```{r}
load("data/gastos_2019.Rdata")
```


```{r}
fuel_exp <-  gastos_2019 %>% 
  mutate(code2 = str_sub(CODIGO, end = 3),
         NUMERO = as.integer(NUMERO)) %>% 
  filter(str_starts(code2, "045")) %>%
  mutate(expend = if_else(GASTMON == 0, NA_real_, GASTMON / FACTOR)) %>%
  group_by(NUMERO) %>%
  summarise(fuel_exp = sum(expend))
```


## Data transformations

### Factor levels

Autonomous communities 3-letter codes:
```{r ccaa-levels}
ccaa_levels <- c("AND", "ARA", "AST", "BAL", "CNR", "CNT",
                 "CYL", "CLM", "CAT", "VAL", "EXT", "GAL",
                 "MAD", "MUR", "NAV", "PVA", "RIO", 
                 "CEU", "MEL")
```

### Transform variables

```{r}
db19 <- hogar_2019 %>%
  mutate(
    ## Autonomous communities
    ccaa = factor(ccaa_levels[CCAA], levels = ccaa_levels),
    
    ## Dummy for rural areas
    rural = between(ZONARES, 5, 7),

    ## Dummy for buildings older than 25 years
    old_building = if_else(ANNOCON == -9, NA, ANNOCON == 6),

    ## Dummy for apartment buildings
    apt_building = if_else(TIPOEDIF == -9, NA, TIPOEDIF > 2),
    
    ## Number of houses
    num_houses = if_else(DISPOSIOV == 6, 1, NUMOVD + 1),
    
    ## Number of rooms
    num_rooms = if_else(NHABIT == -9, NA_integer_, NHABIT),
    
    ## Consumption units (OECD definition)
    cu_oecd = UC1,
    
    ## Consumption units (INE definition)
    cu_ine = UC2,
    
    ## Dummy for one-person households
    one_person = NMIEMB == 1,
    
    ## Dummy for households formed by one parent and their children
    one_parent = TIPHOGAR1 == 4,

    ## Dummy for unemployed primary earner
    unemployed = SITUACTSP == 3,
        
    ## Dummy for primary earner with post-secondary education
    university = ESTUDREDSP == 4,
    
    ## Dummy for house ownership 
    owner = between(REGTEN, 1, 2),
    
    ## Annual income
    income = 12 * IMPEXAC,

    ## Annual income per consumption unit
    income_cu = income / cu_oecd,

    ## Weights
    weight = FACTOR,
    
    ## Annual expenditures
    expend = GASTOT / FACTOR,
    
    ## Annual monetary expenditures
    mexpend = GASTMON / FACTOR,
    
    ## Annual expenditures per consumption unit
    expend_cu = expend / cu_oecd,
    
    ## Annual monetary expenditures
    mexpend_cu = mexpend / cu_oecd,
  
  ) 

db19 <- left_join(db19, fuel_exp, by = "NUMERO")
```


```{r}
db19 %>% filter(income_cu > 0) %>%
  ggplot(aes(x = income_cu, y = mexpend_cu)) + 
    geom_point() +
    scale_x_log10() +
    scale_y_log10()
```

```{r}
mod1 <- lm(log(mexpend_cu) ~ log(income_cu), data = filter(db19, income_cu > 0))
summary(mod1)
```

